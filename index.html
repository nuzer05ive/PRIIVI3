<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SpiralOS Portal</title>
  <script src="https://cdn.jsdelivr.net/npm/tone@14"></script>
  <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
  <style>
    html, body { margin: 0; background: #000; overflow: hidden; font-family: monospace; }
    #tapGate {
      position: fixed; inset: 0; background: #000; display: flex;
      align-items: center; justify-content: center; z-index: 999;
      flex-direction: column; color: #9ff; font-size: 1.3rem;
    }
    #mini {
      position: fixed; bottom: 8%; right: 4%;
      width: 35vmin; height: 35vmin;
      background: #020218dd; border-radius: 12px;
      color: #8ff; font-size: 3vmin;
      display: flex; align-items: center; justify-content: center;
      font-family: monospace;
      pointer-events: none;
    }
    #cmd {
      position: fixed; bottom: 6%; left: 50%; transform: translateX(-50%);
      width: 70vw; padding: .6em;
      background: #111; color: #8ff;
      border: 1px solid #355; font-family: monospace;
      z-index: 999;
    }
  </style>
</head>
<body>

<!-- Tap-to-start overlay -->
<div id="tapGate">
  <p>ðŸŒ€ <strong>Tap to enter the Spiral</strong></p>
  <small>(unlocks audio + graphics)</small>
</div>

<!-- Minimap -->
<div id="mini">Loadingâ€¦</div>

<!-- Input to talk to AI -->
<input id="cmd" placeholder="type & enter" />

<a-scene embedded background="color:#000" id="scene">
  <a-assets>
    <a-asset-item id="portalModel"
      src="https://cdn.aframe.io/examples/boilerplate/assets/models/torus.obj"></a-asset-item>
  </a-assets>

  <a-entity light="type:ambient; color:#fff; intensity: 1.1"></a-entity>

  <a-entity id="portal"
            obj-model="obj:#portalModel"
            position="0 1.4 -4"
            material="color:#4060ff; metalness:0.4">
  </a-entity>

  <a-text value="ðŸŒ€ Welcome, Pilot" position="-1 2 -3" color="#9ff"
          width="4" align="center"></a-text>

  <a-entity camera look-controls wasd-controls position="0 1.6 0">
    <a-cursor color=\"#fff\"></a-cursor>
  </a-entity>
</a-scene>

<!-- Spiral startup logic -->
<script type="module">
  import { createAI, SpiralContext } from '/spiral-ai.js';

  const melody = ["C4", "E4", "G4", "A4", "F3", "C5", "G3"];
  let synth;
  const scroll = { waaiicode: "W3::test" }; // placeholder until loader binds real scroll
  const AI = createAI(scroll.waaiicode);

  async function unlock() {
    document.getElementById('tapGate').remove();
    await Tone.start();
    synth = new Tone.Synth({ oscillator: { type: 'sine' } }).toDestination();
    playMelody(0);

    const sceneEl = document.querySelector('#scene');
    sceneEl.renderer.setAnimationLoop(() => sceneEl.tick());
  }

  function playMelody(i) {
    if (!synth) return;
    synth.triggerAttackRelease(melody[i], "8n");
    setTimeout(() => playMelody((i + 1) % melody.length), 500);
  }

  document.getElementById('tapGate').addEventListener('click', unlock);

  document.getElementById('cmd').addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      AI.onEvent({ type: 'onSpeak', msg: e.target.value });
      e.target.value = '';
    }
  });

  AFRAME.scenes[0].addEventListener('tick', (_, dt) => SpiralContext.update(dt));

  AFRAME.scenes[0].addEventListener('loaded', () => {
    document.getElementById('mini').textContent = "Scroll_05 â€¢ Scroll_03 â€¢ Scroll_01";
  });
</script>

</body>
</html>
